<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ style }} - SanMar Inventory</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <!-- Main Header -->
    <header>
        <h1>SanMar Inventory</h1>
    </header>

    <!-- New header with search bar - SanMar style -->
    <div class="breadcrumb">
        <div class="breadcrumb-links">
            <a href="/">Home</a> &gt; <span>{{ style }}</span>
        </div>
        
        <div class="search-container">
            <form class="search-form" action="/product" method="GET">
                <input type="text" name="style" placeholder="Search by style number..." list="styleSuggestions" autocomplete="off">
                <datalist id="styleSuggestions">
                    <!-- Suggestions will be populated by JavaScript -->
                </datalist>
                <button type="submit">Search</button>
            </form>
        </div>
    </div>
    
    <div class="container">
        <!-- Product Header -->
        <div class="product-header">
            <h2>{{ product_name }}</h2>
            <p class="style-code">Style: {{ style }}</p>
            <div class="product-actions">
                <a href="#" class="action-btn">See Product Details</a>
                <a href="#" class="action-btn">View Spec Sheet</a>
                <a href="https://www.sanmar.com/p/{{ style }}" target="_blank" class="action-btn primary-btn">
                    View on SanMar.com
                </a>
            </div>
        </div>
        
        <!-- Product Content -->
        <div class="product-grid">
            <!-- Left column - Image section with color swatches below -->
            <div class="product-image-section">
                <div class="product-image">
                    {% if catalog_colors|length > 0 and catalog_colors[0] in images %}
                        <img src="{{ images[catalog_colors[0]] }}"
                             id="product-image" alt="{{ product_name }}">
                    {% else %}
                        <img src="https://www.sanmar.com/products/catalog/2022/f1/port__company/fullsize/PC90H_Orange_Model_Front_2022.jpg"
                             id="product-image" alt="{{ product_name }}">
                    {% endif %}
                    
                    {% if on_sale %}
                    <div class="sale-badge">SALE</div>
                    {% endif %}
                </div>
                
                <!-- Color swatches will be below the image -->
                <div class="color-swatches-container">
                    <h3>Available Colors:</h3>
                    <div class="swatches-grid">
                        {% for catalog_color in catalog_colors %}
                        <div class="color-swatch"
                             data-catalog-color="{{ catalog_color }}"
                             data-display-color="{{ display_colors.get(catalog_color, catalog_color) }}"
                             data-image="{{ images.get(catalog_color, '') }}">
                            {% if catalog_color in swatch_images and swatch_images[catalog_color] %}
                                <img src="{{ swatch_images[catalog_color] }}" alt="{{ display_colors.get(catalog_color, catalog_color) }}" style="width: 100%; height: 100%;">
                            {% else %}
                                <span>{{ display_colors.get(catalog_color, catalog_color) }}</span>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            
            <!-- Right column - Product details and pricing/inventory -->
            <div class="product-details">
                <div class="color-selected-info">
                    Color: <span id="selected-color"></span>
                </div>
            <!-- Pricing and Inventory Tables -->
            {% for catalog_color in catalog_colors %}
            {% set display_color = display_colors.get(catalog_color, catalog_color) %}
            <div class="inventory-tables" id="inventory-{{ catalog_color }}" data-display-color="{{ display_color }}" style="display: none;">
                <h4 class="mb-3">Inventory for {{ display_color }}</h4>
                
                <!-- Size options -->
                <div class="size-options">
                    {% for size in sizes %}
                    <div class="size-btn">{{ size }}</div>
                    {% endfor %}
                </div>
                
                <!-- Pricing Information -->
                <div class="pricing-info">
                    <h3>Pricing for {{ display_color }}</h3>
                    
                    <!-- Loading indicator -->
                    <div class="price-loading" id="loading-{{ catalog_color }}">
                        <div class="loading-spinner"></div>
                        <p>Fetching latest pricing data...</p>
                    </div>
                    
                    <!-- Error message -->
                    <div class="price-error" id="error-{{ catalog_color }}">
                        <p>Unable to fetch current pricing. Showing cached data.</p>
                    </div>
                    
                    <div class="table-container">
                        <table class="table pricing-table">
                            <thead>
                                <tr>
                                    <th>Pricing</th>
                                    {% for size in sizes %}
                                    <th>{{ size }}</th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Case Price: $</td>
                                    {% for size in sizes %}
                                    {% if color_pricing and catalog_color in color_pricing and color_pricing[catalog_color].case_price %}
                                        <td>{{ "%.2f"|format(color_pricing[catalog_color].case_price.get(size, 0)) }}</td>
                                    {% else %}
                                        <td>{{ "%.2f"|format(pricing.case_price.get(size, 0)) }}</td>
                                    {% endif %}
                                    {% endfor %}
                                </tr>
                                <tr class="sale-price">
                                    <td>Sale Price: $</td>
                                    {% for size in sizes %}
                                    {% if color_pricing and catalog_color in color_pricing and color_pricing[catalog_color].sale_price %}
                                        <td>{{ "%.2f"|format(color_pricing[catalog_color].sale_price.get(size, 0)) }}</td>
                                    {% else %}
                                        <td>{{ "%.2f"|format(pricing.sale_price.get(size, 0)) }}</td>
                                    {% endif %}
                                    {% endfor %}
                                </tr>
                                <tr class="program-price">
                                    <td>Program Price: $</td>
                                    {% for size in sizes %}
                                    {% if color_pricing and catalog_color in color_pricing and color_pricing[catalog_color].program_price %}
                                        <td>{{ "%.2f"|format(color_pricing[catalog_color].program_price.get(size, 0)) }}</td>
                                    {% else %}
                                        <td>{{ "%.2f"|format(pricing.program_price.get(size, 0)) }}</td>
                                    {% endif %}
                                    {% endfor %}
                                </tr>
                                <tr>
                                    <td>Case Size</td>
                                    {% for size in sizes %}
                                    {% if color_pricing and catalog_color in color_pricing and color_pricing[catalog_color].case_size %}
                                        <td>{{ color_pricing[catalog_color].case_size.get(size, 0) }}</td>
                                    {% else %}
                                        <td>{{ pricing.case_size.get(size, 0) }}</td>
                                    {% endif %}
                                    {% endfor %}
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Inventory Section -->
                <div class="inventory-section">
                    <h3>Inventory Availability</h3>
                    <p class="inventory-total">Total inventory for {{ display_color }}</p>
                    
                    <div class="table-container">
                        <table class="table inventory-table">
                            <thead>
                                <tr>
                                    <th>Warehouse</th>
                                    {% for size in sizes %}
                                    <th>{{ size }}</th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for whse_id, whse_name in warehouses.items() %}
                                <tr>
                                    <td>{{ whse_name if whse_name is string else whse_name.get('name', whse_id) }}</td>
                                    {% for size in sizes %}
                                    {% set display_color = display_colors.get(catalog_color, catalog_color) %}
                                    
                                    <!-- First check the display color -->
                                    {% if display_color in inventory and size in inventory[display_color] and 'warehouses' in inventory[display_color][size] and whse_id in inventory[display_color][size]['warehouses'] %}
                                        <td class="{{ 'in-stock' if inventory[display_color][size]['warehouses'][whse_id] > 10 else 'low-stock' if inventory[display_color][size]['warehouses'][whse_id] > 0 else 'no-stock' }}">
                                            {{ inventory[display_color][size]['warehouses'][whse_id] }}
                                        </td>
                                    
                                    <!-- Then check the catalog color -->
                                    {% elif catalog_color in inventory and size in inventory[catalog_color] and 'warehouses' in inventory[catalog_color][size] and whse_id in inventory[catalog_color][size]['warehouses'] %}
                                        <td class="{{ 'in-stock' if inventory[catalog_color][size]['warehouses'][whse_id] > 10 else 'low-stock' if inventory[catalog_color][size]['warehouses'][whse_id] > 0 else 'no-stock' }}">
                                            {{ inventory[catalog_color][size]['warehouses'][whse_id] }}
                                        </td>
                                    
                                    <!-- Special case for Smoke Grey/ Chrome -->
                                    {% elif display_color == 'Smoke Grey/ Chrome' and 'Smk Gry/Chrome' in inventory and size in inventory['Smk Gry/Chrome'] and 'warehouses' in inventory['Smk Gry/Chrome'][size] and whse_id in inventory['Smk Gry/Chrome'][size]['warehouses'] %}
                                        <td class="{{ 'in-stock' if inventory['Smk Gry/Chrome'][size]['warehouses'][whse_id] > 10 else 'low-stock' if inventory['Smk Gry/Chrome'][size]['warehouses'][whse_id] > 0 else 'no-stock' }}">
                                            {{ inventory['Smk Gry/Chrome'][size]['warehouses'][whse_id] }}
                                        </td>
                                    
                                    <!-- No inventory found -->
                                    {% else %}
                                        <td class="no-stock">0</td>
                                    {% endif %}
                                    {% endfor %}
                                </tr>
                                {% endfor %}
                                <tr class="total-inventory">
                                    <td>Total Inventory</td>
                                    {% for size in sizes %}
                                    {% set display_color = display_colors.get(catalog_color, catalog_color) %}
                                    
                                    <!-- First check the display color -->
                                    {% if display_color in inventory and size in inventory[display_color] and 'total' in inventory[display_color][size] %}
                                        <td class="{{ 'in-stock' if inventory[display_color][size]['total'] > 10 else 'low-stock' if inventory[display_color][size]['total'] > 0 else 'no-stock' }}">
                                            {{ inventory[display_color][size]['total'] }}
                                        </td>
                                    
                                    <!-- Then check the catalog color -->
                                    {% elif catalog_color in inventory and size in inventory[catalog_color] and 'total' in inventory[catalog_color][size] %}
                                        <td class="{{ 'in-stock' if inventory[catalog_color][size]['total'] > 10 else 'low-stock' if inventory[catalog_color][size]['total'] > 0 else 'no-stock' }}">
                                            {{ inventory[catalog_color][size]['total'] }}
                                        </td>
                                    
                                    <!-- Special case for Smoke Grey/ Chrome -->
                                    {% elif display_color == 'Smoke Grey/ Chrome' and 'Smk Gry/Chrome' in inventory and size in inventory['Smk Gry/Chrome'] and 'total' in inventory['Smk Gry/Chrome'][size] %}
                                        <td class="{{ 'in-stock' if inventory['Smk Gry/Chrome'][size]['total'] > 10 else 'low-stock' if inventory['Smk Gry/Chrome'][size]['total'] > 0 else 'no-stock' }}">
                                            {{ inventory['Smk Gry/Chrome'][size]['total'] }}
                                        </td>
                                    
                                    <!-- No inventory found -->
                                    {% else %}
                                        <td class="no-stock">0</td>
                                    {% endif %}
                                    {% endfor %}
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
    // Function to fetch color-specific pricing via AJAX
    function fetchColorPricing(style, color) {
        return new Promise((resolve, reject) => {
            console.log(`Fetching pricing data for style: ${style}, color: ${color}`);
            
            // Show loading indicator
            const loadingElementId = `loading-${color.replace(/\//g, '-')}`;
            const loadingElement = document.getElementById(loadingElementId);
            if (loadingElement) {
                loadingElement.style.display = 'block';
            }
            
            // Hide error message if visible
            const errorElementId = `error-${color.replace(/\//g, '-')}`;
            const errorElement = document.getElementById(errorElementId);
            if (errorElement) {
                errorElement.style.display = 'none';
            }
            
            // Create a URL object
            const url = new URL(`${window.location.origin}/api/pricing`);
            url.searchParams.append('style', style);
            url.searchParams.append('color', color);
            
            // Make the AJAX request
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log(`Received pricing data:`, data);
                    
                    // Hide loading indicator
                    if (loadingElement) {
                        loadingElement.style.display = 'none';
                    }
                    
                    // Check if data contains error flag
                    if (data.error) {
                        console.error(`API error: ${data.message || 'Unknown error'}`);
                        if (errorElement) {
                            errorElement.style.display = 'block';
                            errorElement.querySelector('p').textContent = `Pricing error: ${data.message || 'Unknown error'}`;
                        }
                    }
                    
                    // Client requested to not show sale indicators
                    // No visual indication of sale prices needed
                    
                    resolve(data);
                })
                .catch(error => {
                    console.error(`Error fetching pricing: ${error.message}`);
                    
                    // Hide loading indicator
                    if (loadingElement) {
                        loadingElement.style.display = 'none';
                    }
                    
                    // Show error message
                    if (errorElement) {
                        errorElement.style.display = 'block';
                        errorElement.querySelector('p').textContent = `Unable to fetch pricing data: ${error.message}`;
                    }
                    
                    reject(error);
                });
        });
    }
    
    // Function to update pricing tables with new data
    function updatePricingDisplay(pricingData, tableId) {
        const table = document.getElementById(tableId);
        if (!table) {
            console.error(`Table with ID ${tableId} not found`);
            return;
        }
        
        const pricingTable = table.querySelector('.pricing-table');
        if (!pricingTable) {
            console.error(`Pricing table not found in ${tableId}`);
            return;
        }
        
        // Get the sizes from the table headers in the correct display order
        const sizeHeaders = pricingTable.querySelectorAll('thead th:not(:first-child)');
        const displayedSizes = Array.from(sizeHeaders).map(header => header.textContent.trim());
        
        console.log("Displayed sizes in table order:", displayedSizes);
        
        // Check if the product has sale prices
        // If case price and sale price are the same for all sizes, we don't have a sale
        let hasSale = false;
        if (pricingData.case_price && pricingData.sale_price) {
            for (const size of displayedSizes) {
                if (size && pricingData.case_price[size] && pricingData.sale_price[size] &&
                    pricingData.case_price[size] !== pricingData.sale_price[size]) {
                    hasSale = true;
                    break;
                }
            }
        }
        
        const originalPriceRow = pricingTable.querySelector('tbody tr:nth-child(1)');
        const salePriceRow = pricingTable.querySelector('tbody tr:nth-child(2)');
        const programPriceRow = pricingTable.querySelector('tbody tr:nth-child(3)');
        const caseSizeRow = pricingTable.querySelector('tr:nth-child(4)');
        
        // Update case price row
        if (originalPriceRow && pricingData.case_price) {
            // Always use "Case Price: $" label
            const labelCell = originalPriceRow.querySelector('td:first-child');
            if (labelCell) {
                labelCell.textContent = "Case Price: $";
            }
            
            const cells = originalPriceRow.querySelectorAll('td:not(:first-child)');
            cells.forEach((cell, index) => {
                const size = displayedSizes[index];
                if (size && pricingData.case_price[size]) {
                    cell.textContent = pricingData.case_price[size].toFixed(2);
                }
            });
        }
        
        // Determine if we need to show the sale price row
        // Only show it if there's a sale AND the sale price is better than the program price for at least one size
        if (salePriceRow) {
            let showSalePriceRow = false;
            
            if (hasSale && pricingData.sale_price && pricingData.program_price) {
                // Check if the sale price is better than the program price for any size
                for (const size of displayedSizes) {
                    if (size &&
                        pricingData.sale_price[size] &&
                        pricingData.program_price[size] &&
                        pricingData.sale_price[size] < pricingData.program_price[size]) {
                        showSalePriceRow = true;
                        break;
                    }
                }
            }
            
            if (showSalePriceRow) {
                salePriceRow.style.display = '';
                // Update sale price values
                const cells = salePriceRow.querySelectorAll('td:not(:first-child)');
                cells.forEach((cell, index) => {
                    const size = displayedSizes[index];
                    if (size && pricingData.sale_price[size]) {
                        cell.textContent = pricingData.sale_price[size].toFixed(2);
                    }
                });
            } else {
                // Hide sale price row if there's no sale or if program price is better
                salePriceRow.style.display = 'none';
            }
        }
        
        // Always show program price row
        if (programPriceRow) {
            programPriceRow.style.display = '';
            
            // Update program price values
            if (pricingData.program_price) {
                const cells = programPriceRow.querySelectorAll('td:not(:first-child)');
                cells.forEach((cell, index) => {
                    const size = displayedSizes[index];
                    if (size && pricingData.program_price[size]) {
                        cell.textContent = pricingData.program_price[size].toFixed(2);
                    }
                });
            }
        }
        
        // Always update case size row
        if (caseSizeRow && pricingData.case_size) {
            const cells = caseSizeRow.querySelectorAll('td:not(:first-child)');
            cells.forEach((cell, index) => {
                const size = displayedSizes[index];
                if (size && pricingData.case_size[size]) {
                    cell.textContent = pricingData.case_size[size];
                }
            });
        }
        
        console.log('Pricing display updated successfully');
    }

    // Wait until DOM is fully loaded before attaching event handlers
    document.addEventListener('DOMContentLoaded', function() {
        // Find and set up the color swatches with proper error handling
        try {
            // Set up the color swatches
            document.querySelectorAll('.color-swatch').forEach(function(swatch) {
                swatch.addEventListener('click', function() {
                    try {
                        // Extract data attributes safely with explicit debug info
                        const catalogColor = this.getAttribute('data-catalog-color') || '';
                        const displayColor = this.getAttribute('data-display-color') || catalogColor;
                        const imageUrl = this.getAttribute('data-image') || '';
                        
                        console.log(`Swatch clicked: ${catalogColor}, display: ${displayColor}, image: ${imageUrl}`);
                        
                        // Stop here if we don't have a valid catalog color
                        if (!catalogColor) {
                            console.error('No catalog color found on swatch element');
                            return;
                        }
                        
                        // Stop here if we don't have a valid image URL
                        if (!imageUrl) {
                            console.warn('No image URL found on swatch element');
                            // Continue anyway as we can update other elements
                        }
                        
                        // Safely update selected color text
                        const selectedColorElement = document.getElementById('selected-color');
                        if (selectedColorElement) {
                            selectedColorElement.textContent = displayColor;
                            console.log(`Updated selected color text to: ${displayColor}`);
                        } else {
                            console.error('Selected color element not found');
                        }
                        
                        // Update active swatch styling
                        document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('active'));
                        this.classList.add('active');
                        console.log(`Updated active swatch to: ${catalogColor}`);
                        
                        // Safely update product image - this is critical!
                        const productImage = document.getElementById('product-image');
                        if (productImage && imageUrl) {
                            console.log(`Updating image from ${productImage.src} to ${imageUrl}`);
                            
                            // Force a reflow with a small timeout to ensure the image updates
                            setTimeout(() => {
                                productImage.src = imageUrl;
                                
                                // Also update the alt text for accessibility
                                if (productImage.alt) {
                                    const altParts = productImage.alt.split(' ');
                                    if (altParts.length > 1) {
                                        productImage.alt = `${displayColor} ${altParts.slice(1).join(' ')}`;
                                    } else {
                                        productImage.alt = displayColor;
                                    }
                                } else {
                                    productImage.alt = displayColor;
                                }
                                
                                console.log(`Image updated to: ${imageUrl}`);
                            }, 10);
                        } else {
                            console.error(`Product image element ${productImage ? 'found' : 'not found'}, imageUrl ${imageUrl ? 'valid' : 'invalid'}`);
                        }
                        
                        // Hide all inventory tables
                        const allTables = document.querySelectorAll('.inventory-tables');
                        console.log(`Found ${allTables.length} inventory tables to hide`);
                        allTables.forEach(table => {
                            table.style.display = 'none';
                        });
                        
                        // Get the corresponding inventory table for this color
                        // Try multiple approaches to find the right table
                        
                        // First: Try direct ID match using fully sanitized catalog color
                        // Replace all potentially problematic characters
                        const safeColorId = catalogColor.replace(/[\/\s.&]+/g, '-');
                        let tableId = `inventory-${safeColorId}`;
                        console.log(`Looking for table with ID: ${tableId}`);
                        let table = document.getElementById(tableId);
                        
                        // Second: Try with more aggressive sanitization
                        if (!table) {
                            // Try even more aggressive sanitization - removing special chars completely
                            const extraSafeColorId = catalogColor.replace(/[^a-zA-Z0-9]/g, '');
                            tableId = `inventory-${extraSafeColorId}`;
                            console.log(`Not found, trying more aggressive ID: ${tableId}`);
                            table = document.getElementById(tableId);
                        }
                        
                        // Third: Try to match using the exact ID from the template
                        if (!table) {
                            console.warn(`Table not found by sanitized IDs, trying exact catalog color...`);
                            table = document.getElementById(`inventory-${catalogColor}`);
                        }
                        
                        // Fourth: Try using a partial match on the ID attribute
                        if (!table) {
                            console.warn(`Still no match, trying partial ID match`);
                            const tables = document.querySelectorAll('.inventory-tables');
                            for (const t of tables) {
                                if (t.id.includes(catalogColor) || catalogColor.includes(t.id.replace('inventory-', ''))) {
                                    table = t;
                                    console.log(`Found table with partial ID match: ${t.id}`);
                                    break;
                                }
                            }
                        }
                        
                        // Fifth: Try matching by data-display-color attribute
                        if (!table) {
                            console.warn(`Table not found by ID matching, trying data-display-color attribute...`);
                            table = document.querySelector(`.inventory-tables[data-display-color="${displayColor}"]`);
                            
                            // Try partial match on data-display-color as well
                            if (!table) {
                                const tables = document.querySelectorAll('.inventory-tables');
                                for (const t of tables) {
                                    const dataColor = t.getAttribute('data-display-color');
                                    if (dataColor && (dataColor.includes(displayColor) || displayColor.includes(dataColor))) {
                                        table = t;
                                        console.log(`Found table with partial data-display-color match: ${dataColor}`);
                                        break;
                                    }
                                }
                            }
                        }
                        
                        // If we found a table, show it and update its data
                        if (table) {
                            // Update the inventory table header and content to match the selected color
                            const inventoryHeader = table.querySelector('h4');
                            if (inventoryHeader) {
                                inventoryHeader.textContent = `Inventory for ${displayColor}`;
                            }
                            
                            const inventoryTotal = table.querySelector('.inventory-total');
                            if (inventoryTotal) {
                                inventoryTotal.textContent = `Total inventory for ${displayColor}`;
                            }
                            
                            const pricingHeader = table.querySelector('.pricing-info h3');
                            if (pricingHeader) {
                                pricingHeader.textContent = `Pricing for ${displayColor}`;
                            }
                            
                            // Show the table
                            table.style.display = 'block';
                            console.log(`Showing inventory table for ${displayColor}`);
                            
                            // Fetch updated pricing data
                            const path = window.location.pathname;
                            const style = path.includes('/') ? path.split('/').pop() : path;
                            
                            if (style) {
                                console.log(`Fetching pricing data for style: ${style}, color: ${catalogColor}`);
                                fetchColorPricing(style, catalogColor)
                                    .then(data => {
                                        if (data && !data.error) {
                                            console.log(`Successfully retrieved pricing data for ${displayColor}`, data);
                                            updatePricingDisplay(data, table.id);
                                            
                                            // Hide the error message if visible
                                            const errorElement = table.querySelector('.price-error');
                                            if (errorElement) {
                                                errorElement.style.display = 'none';
                                            }
                                        } else {
                                            // Show error message but still try to use the data we got
                                            console.warn(`Received error or incomplete pricing data`, data);
                                            if (data) updatePricingDisplay(data, table.id);
                                            
                                            const errorElement = table.querySelector('.price-error');
                                            if (errorElement) {
                                                errorElement.style.display = 'block';
                                            }
                                        }
                                    })
                                    .catch(error => {
                                        console.error(`Error updating pricing: ${error.message}`);
                                        
                                        // Show error message
                                        const errorElement = table.querySelector('.price-error');
                                        if (errorElement) {
                                            errorElement.style.display = 'block';
                                            errorElement.querySelector('p').textContent = 'Unable to fetch current pricing. Showing cached data.';
                                        }
                                    });
                            }
                        } else {
                            // Last resort - just show the first inventory table if we really can't find a match
                            console.error(`No matching table found for color: ${displayColor}`);
                            const firstTable = document.querySelector('.inventory-tables');
                            if (firstTable) {
                                // Update headers to match the selected color
                                const inventoryHeader = firstTable.querySelector('h4');
                                if (inventoryHeader) {
                                    inventoryHeader.textContent = `Inventory for ${displayColor}`;
                                }
                                
                                const inventoryTotal = firstTable.querySelector('.inventory-total');
                                if (inventoryTotal) {
                                    inventoryTotal.textContent = `Total inventory for ${displayColor}`;
                                }
                                
                                const pricingHeader = firstTable.querySelector('.pricing-info h3');
                                if (pricingHeader) {
                                    pricingHeader.textContent = `Pricing for ${displayColor}`;
                                }
                                
                                firstTable.style.display = 'block';
                                console.log(`Showing first available inventory table as last resort`);
                                
                                // At least try to fetch the pricing
                                const path = window.location.pathname;
                                const style = path.includes('/') ? path.split('/').pop() : path;
                                if (style) {
                                    fetchColorPricing(style, catalogColor)
                                        .then(data => {
                                            if (data) updatePricingDisplay(data, firstTable.id);
                                        })
                                        .catch(error => {
                                            console.error(`Error updating pricing: ${error.message}`);
                                            const errorElement = firstTable.querySelector('.price-error');
                                            if (errorElement) {
                                                errorElement.style.display = 'block';
                                            }
                                        });
                                }
                            }
                        }
                    } catch (err) {
                        console.error('Error in swatch click handler:', err);
                    }
                });
                
                // Set up hover effect
                swatch.addEventListener('mouseenter', function() {
                    try {
                        const displayColor = this.getAttribute('data-display-color') || '';
                        const colorInfo = document.querySelector('.color-selected-info');
                        if (colorInfo) {
                            colorInfo.setAttribute('data-original', colorInfo.textContent || '');
                            colorInfo.textContent = `Color: ${displayColor}`;
                        }
                    } catch (err) {
                        console.error('Error in swatch hover handler:', err);
                    }
                });
                
                swatch.addEventListener('mouseleave', function() {
                    try {
                        const colorInfo = document.querySelector('.color-selected-info');
                        if (colorInfo && colorInfo.hasAttribute('data-original')) {
                            colorInfo.textContent = colorInfo.getAttribute('data-original');
                        }
                    } catch (err) {
                        console.error('Error in swatch leave handler:', err);
                    }
                });
            });
            
            // Select the first color by default
            const firstSwatch = document.querySelector('.color-swatch');
            if (firstSwatch) {
                // Use setTimeout to ensure DOM is fully loaded
                setTimeout(() => {
                    firstSwatch.click();
                }, 100);
            }
        } catch (err) {
            console.error('Error setting up color swatches:', err);
        }
        
        // Set up autocomplete for style search
        try {
            const styleInput = document.querySelector('.search-form input[name="style"]');
            if (styleInput) {
                styleInput.addEventListener('input', function() {
                    const query = this.value.trim();
                    if (query.length >= 2) {
                        fetch(`/autocomplete?q=${encodeURIComponent(query)}`)
                            .then(response => response.json())
                            .then(data => {
                                const datalist = document.getElementById('styleSuggestions');
                                if (datalist) {
                                    datalist.innerHTML = '';
                                    data.forEach(style => {
                                        const option = document.createElement('option');
                                        option.value = style;
                                        datalist.appendChild(option);
                                    });
                                }
                            })
                            .catch(error => console.error(`Error fetching autocomplete: ${error}`));
                    }
                });
            }
        } catch (err) {
            console.error('Error setting up autocomplete:', err);
        }
    });
</script>
</body>
</html>
