<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ style }} Inventory</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <style>
        .swatch { width: 40px; height: 40px; display: inline-block; margin: 5px; cursor: pointer; border: 1px solid #ccc; }
        .swatch img { width: 100%; height: 100%; }
        .selected { border: 2px solid #007bff; }
        .on-sale { color: red; }
        .main-image img { max-width: 100%; height: auto; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <!-- Product Image and Swatches -->
            <div class="col-12 col-lg-3 product-details">
                <div class="row">
                    <div class="col-4 col-lg-12">
                        <div class="main-image" id="main-image">
                            <img src="{{ images[colors[0]] }}" alt="Main image" class="img-responsive">
                        </div>
                    </div>
                    <div class="col-12 mt-3">
                        <h3>Colors</h3>
                        <div id="swatches" class="color-swatches-inventory">
                            {% for color in colors %}
                            <div class="swatch {% if loop.first %}selected{% endif %}" onclick="selectColor('{{ color }}', this)">
                                <img src="{{ images[color] }}" alt="{{ color }}">
                                <span class="swatch-name">{{ color }}</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Inventory Table -->
            <div class="col-12 col-lg-9">
                <h1>{{ style }} - <span id="selected-color">{{ colors[0] }}</span></h1>
                <table class="table table-striped" id="inventory-table">
                    <thead>
                        <tr>
                            <th></th>
                            {% for size in sizes %}
                            <th>{{ size }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="original-price">
                            <td>Original Price: $</td>
                            {% for size in sizes %}
                            <td data-size="{{ size }}"></td>
                            {% endfor %}
                        </tr>
                        <tr class="sale-price">
                            <td>Sale Price: $</td>
                            {% for size in sizes %}
                            <td data-size="{{ size }}" class="on-sale"></td>
                            {% endfor %}
                        </tr>
                        <tr class="program-price">
                            <td>Program Price: $</td>
                            {% for size in sizes %}
                            <td data-size="{{ size }}"></td>
                            {% endfor %}
                        </tr>
                        <tr class="case-size">
                            <td>Case Size</td>
                            {% for size in sizes %}
                            <td data-size="{{ size }}"></td>
                            {% endfor %}
                        </tr>
                        {% for whse_code, whse_name in warehouses.items() %}
                        <tr class="warehouse-{{ whse_code }}">
                            <td>{{ whse_name }}</td>
                            {% for size in sizes %}
                            <td data-size="{{ size }}" data-warehouse="{{ whse_code }}">0</td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                        <tr class="total-row">
                            <td><strong>Total Inventory</strong></td>
                            {% for size in sizes %}
                            <td data-size="{{ size }}">0</td>
                            {% endfor %}
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Parse JSON data from Flask
        const inventoryData = JSON.parse('{{ inventory_json | safe }}');
        const pricingData = JSON.parse('{{ pricing_json | safe }}');
        const partIdMap = JSON.parse('{{ part_id_map_json | safe }}');
        const images = JSON.parse('{{ images|tojson }}');
        const sizes = JSON.parse('{{ sizes|tojson }}');
        const warehousesData = JSON.parse('{{ warehouses|tojson }}');
        
        let selectedColor = "{{ colors[0] }}";

        function updateTable(color) {
            selectedColor = color;
            const partIds = partIdMap[color];

            // Update pricing
            sizes.forEach(size => {
                const partId = partIds[size];
                const pricing = pricingData[partId] || {};
                document.querySelector(`.original-price td[data-size="${size}"]`).textContent = pricing.original || 'N/A';
                const saleCell = document.querySelector(`.sale-price td[data-size="${size}"]`);
                saleCell.textContent = pricing.sale || '';
                saleCell.classList.toggle('on-sale', !!pricing.sale);
                document.querySelector(`.program-price td[data-size="${size}"]`).textContent = pricing.program || '';
                document.querySelector(`.case-size td[data-size="${size}"]`).textContent = pricing.case_size || 'N/A';
            });

            // Update inventory
            sizes.forEach(size => {
                const partId = partIds[size];
                const inventory = inventoryData[partId] || { total: 0, warehouses: {} };
                Object.keys(warehousesData).forEach(whse => {
                    const cell = document.querySelector(`.warehouse-${whse} td[data-size="${size}"]`);
                    cell.textContent = inventory.warehouses[whse] || 0;
                });
                document.querySelector(`.total-row td[data-size="${size}"]`).textContent = inventory.total || 0;
            });

            // Update main image
            document.getElementById('main-image').innerHTML = `<img src="${images[color]}" alt="${color}" class="img-responsive">`;
            document.getElementById('selected-color').textContent = color;
        }

        function selectColor(color, element) {
            updateTable(color);
            document.querySelectorAll('.swatch').forEach(s => s.classList.remove('selected'));
            element.classList.add('selected');
        }

        // Initial load
        updateTable(selectedColor);
    </script>
</body>
</html>
