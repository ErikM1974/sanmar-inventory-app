<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ style }} - SanMar Inventory</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        /* Loading spinner overlay */
        #loading-spinner {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .spinner-container {
            text-align: center;
        }
        
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        
        .spinner-message {
            margin-top: 1rem;
            font-weight: bold;
        }
    </style>
    <!-- Add script to show and hide spinner -->
    <script>
        // Show spinner immediately
        (function() {
            // Add style element to force spinner display
            var style = document.createElement('style');
            style.textContent = '#loading-spinner{display:flex !important;}';
            document.head.appendChild(style);
            
            // Set a backup timeout to ensure spinner is hidden after 10 seconds max
            // This prevents it from getting stuck forever
            setTimeout(function() {
                var spinner = document.getElementById('loading-spinner');
                if (spinner) {
                    spinner.style.display = 'none';
                }
            }, 10000);
            
            // Normal spinner hide logic on page load
            function hideSpinner() {
                setTimeout(function() {
                    var spinner = document.getElementById('loading-spinner');
                    if (spinner) {
                        spinner.style.display = 'none';
                    }
                }, 500);
            }
            
            // Attach to both DOMContentLoaded and load events
            if (document.readyState === 'complete' || document.readyState === 'interactive') {
                // Page already loaded
                hideSpinner();
            } else {
                window.addEventListener('DOMContentLoaded', function() {
                    window.addEventListener('load', hideSpinner);
                });
                window.addEventListener('load', hideSpinner);
            }
        })();
    </script>
</head>
<body>
    <!-- Loading Spinner Overlay -->
    <div id="loading-spinner">
        <div class="spinner-container">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div class="spinner-message">Loading product data...</div>
        </div>
    </div>
    <!-- Main Header -->
    <header class="py-3 mb-3 text-center">
        <h1>SanMar Inventory</h1>
    </header>

    <!-- Simplified header with breadcrumb only - search box removed -->
    <div class="container mb-4">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">Home</a></li>
                <li class="breadcrumb-item active" aria-current="page">{{ style }}</li>
            </ol>
        </nav>
    </div>
    
    <div class="container bg-white p-4 rounded shadow-sm">
        <!-- Product Header -->
        <div class="product-header mb-4 pb-3 border-bottom">
            <h2 class="mb-2">{{ product_name }}</h2>
            <p class="text-muted">Style: {{ style }}</p>
        </div>
        
        <!-- Product Content -->
        <div class="row">
            <!-- Left column - Image section with color swatches below -->
            <div class="col-md-4 mb-4">
                <div class="position-relative">
                    {% if catalog_colors|length > 0 and catalog_colors[0] in images %}
                        <img src="{{ images[catalog_colors[0]] }}"
                             id="product-image" alt="{{ product_name }}" class="img-fluid rounded">
                    {% else %}
                        <img src="https://www.sanmar.com/products/catalog/2022/f1/port__company/fullsize/PC90H_Orange_Model_Front_2022.jpg"
                             id="product-image" alt="{{ product_name }}" class="img-fluid rounded">
                    {% endif %}
                    
                    {% if on_sale %}
                    <div class="position-absolute top-0 start-0 bg-danger text-white px-2 py-1 rounded-end">SALE</div>
                    {% endif %}
                </div>
                
                <!-- Color swatches will be below the image -->
                <div class="mt-4">
                    <h3 class="h5 mb-3">Available Colors:</h3>
                    <div class="d-flex flex-wrap gap-2 position-relative">
                        {% for catalog_color in catalog_colors %}
                        <div class="color-swatch border rounded p-1" style="width: 50px; height: 50px; cursor: pointer;"
                             data-catalog-color="{{ catalog_color }}"
                             data-display-color="{{ display_colors.get(catalog_color, catalog_color) }}"
                             data-image="{{ images.get(catalog_color, '') }}"
                             title="{{ display_colors.get(catalog_color, catalog_color) }}">
                            <div class="swatch-label">{{ display_colors.get(catalog_color, catalog_color) }}</div>
                            {% if catalog_color in swatch_images and swatch_images[catalog_color] %}
                                <img src="{{ swatch_images[catalog_color] }}" alt="{{ display_colors.get(catalog_color, catalog_color) }}" style="width: 100%; height: 100%;">
                            {% else %}
                                <span class="d-flex justify-content-center align-items-center h-100 text-center small">{{ display_colors.get(catalog_color, catalog_color) }}</span>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            
            <!-- Right column - Product details and pricing/inventory -->
            <div class="col-md-8">
                <div class="mb-3 p-2 bg-light rounded">
                    <strong>Color:</strong> <span id="selected-color"></span>
                </div>
            <!-- Pricing and Inventory Tables -->
            {% for catalog_color in catalog_colors %}
            {% set display_color = display_colors.get(catalog_color, catalog_color) %}
            <div class="inventory-tables" id="inventory-{{ catalog_color }}" data-display-color="{{ display_color }}" style="display: none;">
                <h4 class="mb-3">Inventory for {{ display_color }}</h4>
                
                <!-- Pricing Information -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h3 class="h5 mb-0">Pricing for {{ display_color }}</h3>
                    </div>
                    <div class="card-body">
                        <!-- Loading indicator -->
                        <div class="price-loading text-center my-3" id="loading-{{ catalog_color }}" style="display: none;">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Fetching latest pricing data...</p>
                        </div>
                        
                        <!-- Error message -->
                        <div class="price-error alert alert-warning" id="error-{{ catalog_color }}" style="display: none;">
                            <p class="mb-0">Unable to fetch current pricing. Showing cached data.</p>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-bordered table-striped pricing-table">
                            <thead>
                                <tr>
                                    <th>Pricing</th>
                                    {% for size in sizes %}
                                    <th>{{ size }}</th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Case Price: $</td>
                                    {% for size in sizes %}
                                    {% if color_pricing and catalog_color in color_pricing and color_pricing[catalog_color].case_price %}
                                        <td>{{ "%.2f"|format(color_pricing[catalog_color].case_price.get(size, 0)) }}</td>
                                    {% else %}
                                        <td>{{ "%.2f"|format(pricing.case_price.get(size, 0)) }}</td>
                                    {% endif %}
                                    {% endfor %}
                                </tr>
                                <tr class="sale-price text-danger">
                                    <td>Sale Price: $</td>
                                    {% for size in sizes %}
                                    {% if color_pricing and catalog_color in color_pricing and color_pricing[catalog_color].sale_price %}
                                        <td>{{ "%.2f"|format(color_pricing[catalog_color].sale_price.get(size, 0)) }}</td>
                                    {% else %}
                                        <td>{{ "%.2f"|format(pricing.sale_price.get(size, 0)) }}</td>
                                    {% endif %}
                                    {% endfor %}
                                </tr>
                                <tr class="program-price text-success">
                                    <td>Program Price: $</td>
                                    {% for size in sizes %}
                                    {% if color_pricing and catalog_color in color_pricing and color_pricing[catalog_color].program_price %}
                                        <td>{{ "%.2f"|format(color_pricing[catalog_color].program_price.get(size, 0)) }}</td>
                                    {% else %}
                                        <td>{{ "%.2f"|format(pricing.program_price.get(size, 0)) }}</td>
                                    {% endif %}
                                    {% endfor %}
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
                
            <!-- Inventory Section -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h3 class="h5 mb-0">Inventory Availability</h3>
                </div>
                <div class="card-body">
                    <p class="inventory-total mb-3">Total inventory for {{ display_color }}</p>
                    
                    <div class="table-responsive">
                        <table class="table table-bordered table-striped inventory-table">
                            <thead>
                                <tr>
                                    <th>Warehouse</th>
                                    {% for size in sizes %}
                                    <th>{{ size }}</th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for whse_id, whse_name in warehouses.items() %}
                                <tr>
                                    <td>{{ whse_name if whse_name is string else whse_name.get('name', whse_id) }}</td>
                                    {% for size in sizes %}
                                    {% set display_color = display_colors.get(catalog_color, catalog_color) %}
                                    
                                    <!-- First check the display color -->
                                    {% if display_color in inventory and size in inventory[display_color] and 'warehouses' in inventory[display_color][size] and whse_id in inventory[display_color][size]['warehouses'] %}
                                        {% set stock_qty = inventory[display_color][size]['warehouses'][whse_id] %}
                                        <td class="text-center {% if stock_qty > 10 %}bg-success text-white{% elif stock_qty > 0 %}bg-warning{% else %}bg-light text-muted{% endif %}">
                                            {{ stock_qty }}
                                        </td>
                                    
                                    <!-- Then check the catalog color -->
                                    {% elif catalog_color in inventory and size in inventory[catalog_color] and 'warehouses' in inventory[catalog_color][size] and whse_id in inventory[catalog_color][size]['warehouses'] %}
                                        {% set stock_qty = inventory[catalog_color][size]['warehouses'][whse_id] %}
                                        <td class="text-center {% if stock_qty > 10 %}bg-success text-white{% elif stock_qty > 0 %}bg-warning{% else %}bg-light text-muted{% endif %}">
                                            {{ stock_qty }}
                                        </td>
                                    
                                    <!-- Special case for Smoke Grey/ Chrome -->
                                    {% elif display_color == 'Smoke Grey/ Chrome' and 'Smk Gry/Chrome' in inventory and size in inventory['Smk Gry/Chrome'] and 'warehouses' in inventory['Smk Gry/Chrome'][size] and whse_id in inventory['Smk Gry/Chrome'][size]['warehouses'] %}
                                        {% set stock_qty = inventory['Smk Gry/Chrome'][size]['warehouses'][whse_id] %}
                                        <td class="text-center {% if stock_qty > 10 %}bg-success text-white{% elif stock_qty > 0 %}bg-warning{% else %}bg-light text-muted{% endif %}">
                                            {{ stock_qty }}
                                        </td>
                                    
                                    <!-- No inventory found -->
                                    {% else %}
                                        <td class="text-center text-muted bg-light">0</td>
                                    {% endif %}
                                    {% endfor %}
                                </tr>
                                {% endfor %}
                                <tr class="total-inventory fw-bold">
                                    <td>Total Inventory</td>
                                    {% for size in sizes %}
                                    {% set display_color = display_colors.get(catalog_color, catalog_color) %}
                                    
                                    <!-- First check the display color -->
                                    {% if display_color in inventory and size in inventory[display_color] and 'total' in inventory[display_color][size] %}
                                        {% set stock_qty = inventory[display_color][size]['total'] %}
                                        <td class="text-center {% if stock_qty > 10 %}bg-success text-white{% elif stock_qty > 0 %}bg-warning{% else %}bg-light text-muted{% endif %}">
                                            {{ stock_qty }}
                                        </td>
                                    
                                    <!-- Then check the catalog color -->
                                    {% elif catalog_color in inventory and size in inventory[catalog_color] and 'total' in inventory[catalog_color][size] %}
                                        {% set stock_qty = inventory[catalog_color][size]['total'] %}
                                        <td class="text-center {% if stock_qty > 10 %}bg-success text-white{% elif stock_qty > 0 %}bg-warning{% else %}bg-light text-muted{% endif %}">
                                            {{ stock_qty }}
                                        </td>
                                    
                                    <!-- Special case for Smoke Grey/ Chrome -->
                                    {% elif display_color == 'Smoke Grey/ Chrome' and 'Smk Gry/Chrome' in inventory and size in inventory['Smk Gry/Chrome'] and 'total' in inventory['Smk Gry/Chrome'][size] %}
                                        {% set stock_qty = inventory['Smk Gry/Chrome'][size]['total'] %}
                                        <td class="text-center {% if stock_qty > 10 %}bg-success text-white{% elif stock_qty > 0 %}bg-warning{% else %}bg-light text-muted{% endif %}">
                                            {{ stock_qty }}
                                        </td>
                                    
                                    <!-- No inventory found -->
                                    {% else %}
                                        <td class="text-center text-muted bg-light">0</td>
                                    {% endif %}
                                    {% endfor %}
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            </div>
            {% endfor %}
            </div>
        </div>
    </div>

<script>
    // Function to fetch color-specific pricing via AJAX
    function fetchColorPricing(style, color) {
        return new Promise((resolve, reject) => {
            console.log(`Fetching pricing data for style: ${style}, color: ${color}`);
            
            // Show loading indicator
            const loadingElementId = `loading-${color.replace(/\//g, '-')}`;
            const loadingElement = document.getElementById(loadingElementId);
            if (loadingElement) {
                loadingElement.style.display = 'block';
                
                // Set a safety timeout to hide the loading indicator if fetch takes too long
                setTimeout(() => {
                    if (loadingElement) {
                        loadingElement.style.display = 'none';
                    }
                }, 10000); // 10 second timeout
            }
            
            // Hide error message if visible
            const errorElementId = `error-${color.replace(/\//g, '-')}`;
            const errorElement = document.getElementById(errorElementId);
            if (errorElement) {
                errorElement.style.display = 'none';
            }
            
            // Create a URL object
            const url = new URL(`${window.location.origin}/api/pricing`);
            url.searchParams.append('style', style);
            url.searchParams.append('color', color);
            
            // Make the AJAX request
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log(`Received pricing data:`, data);
                    
                    // Log specific pricing data for debugging
                    if (data.case_price) {
                        console.log("Case Price data:", data.case_price);
                        const sizes = Object.keys(data.case_price);
                        if (sizes.length > 0) {
                            console.log(`Sample case price for size ${sizes[0]}: ${data.case_price[sizes[0]]}`);
                        } else {
                            console.warn("Case price object exists but has no size keys");
                        }
                    } else {
                        console.warn("No case_price object in API response");
                        // Check if original_price is available as fallback
                        if (data.original_price) {
                            console.log("Original Price data (fallback):", data.original_price);
                        }
                    }
                    
                    // Hide loading indicator
                    if (loadingElement) {
                        loadingElement.style.display = 'none';
                    }
                    
                    // Check if data contains error flag
                    if (data.error) {
                        console.error(`API error: ${data.message || 'Unknown error'}`);
                        if (errorElement) {
                            errorElement.style.display = 'block';
                            errorElement.querySelector('p').textContent = `Pricing error: ${data.message || 'Unknown error'}`;
                        }
                    }
                    
                    // Client requested to not show sale indicators
                    // No visual indication of sale prices needed
                    
                    resolve(data);
                })
                .catch(error => {
                    console.error(`Error fetching pricing: ${error.message}`);
                    
                    // Hide loading indicator
                    if (loadingElement) {
                        loadingElement.style.display = 'none';
                    }
                    
                    // Show error message
                    if (errorElement) {
                        errorElement.style.display = 'block';
                        errorElement.querySelector('p').textContent = `Unable to fetch pricing data: ${error.message}`;
                    }
                    
                    reject(error);
                });
        });
    }
    
    // Function to update pricing tables with new data
    function updatePricingDisplay(pricingData, tableId) {
        const table = document.getElementById(tableId);
        if (!table) {
            console.error(`Table with ID ${tableId} not found`);
            return;
        }
        
        const pricingTable = table.querySelector('.pricing-table');
        if (!pricingTable) {
            console.error(`Pricing table not found in ${tableId}`);
            return;
        }
        
        // Get the sizes from the table headers in the correct display order
        const sizeHeaders = pricingTable.querySelectorAll('thead th:not(:first-child)');
        const displayedSizes = Array.from(sizeHeaders).map(header => header.textContent.trim());
        
        console.log("Displayed sizes in table order:", displayedSizes);
        
        // Check if the product has sale prices
        // If case price and sale price are the same for all sizes, we don't have a sale
        let hasSale = false;
        if (pricingData.case_price && pricingData.sale_price) {
            for (const size of displayedSizes) {
                if (size && pricingData.case_price[size] && pricingData.sale_price[size] &&
                    pricingData.case_price[size] !== pricingData.sale_price[size]) {
                    hasSale = true;
                    break;
                }
            }
        }
        
        const originalPriceRow = pricingTable.querySelector('tbody tr:nth-child(1)');
        const salePriceRow = pricingTable.querySelector('tbody tr:nth-child(2)');
        const programPriceRow = pricingTable.querySelector('tbody tr:nth-child(3)');
        
        // Update case price row
        console.log("Received pricing data for updating:", pricingData);
        console.log("Case price data:", pricingData.case_price);
        console.log("Original price data:", pricingData.original_price);
        
        if (originalPriceRow) {
            // Always use "Case Price: $" label
            const labelCell = originalPriceRow.querySelector('td:first-child');
            if (labelCell) {
                labelCell.textContent = "Case Price: $";
            }
            
            console.log("Updating case price row. Displayed sizes:", displayedSizes);
            const cells = originalPriceRow.querySelectorAll('td:not(:first-child)');
            console.log(`Found ${cells.length} cells to update in case price row`);
            
            // Combine case_price and original_price for more robust display
            const combinedPriceData = {};
            
            // Create a more reliable data source for prices
            // Log exact data we're receiving for debugging
            console.log("DETAILED CASE PRICE DATA:", JSON.stringify(pricingData.case_price));
            
            // First, copy any available case price data - only use non-null, non-zero values
            if (pricingData.case_price) {
                for (const size in pricingData.case_price) {
                    if (pricingData.case_price[size] !== null && pricingData.case_price[size] !== undefined && pricingData.case_price[size] !== 0) {
                        combinedPriceData[size] = pricingData.case_price[size];
                        console.log(`Using direct case_price for size ${size}: ${pricingData.case_price[size]}`);
                    }
                }
            }
            
            // Then, fill in any missing sizes from original_price as fallback
            if (pricingData.original_price) {
                for (const size in pricingData.original_price) {
                    if (!combinedPriceData[size] || combinedPriceData[size] === 0) {
                        if (pricingData.original_price[size] !== null && pricingData.original_price[size] !== undefined && pricingData.original_price[size] !== 0) {
                            combinedPriceData[size] = pricingData.original_price[size];
                            console.log(`Using original_price as fallback for size ${size}: ${pricingData.original_price[size]}`);
                        }
                    }
                }
            }
            
            // If we still have no data for a size, try direct access to any other price field
            for (const size of displayedSizes) {
                if (!combinedPriceData[size] || combinedPriceData[size] === 0) {
                    // Try other price fields as last resort
                    if (pricingData.program_price && pricingData.program_price[size]) {
                        combinedPriceData[size] = pricingData.program_price[size];
                        console.log(`Last resort: using program_price for ${size}: ${pricingData.program_price[size]}`);
                    } else if (pricingData.sale_price && pricingData.sale_price[size]) {
                        combinedPriceData[size] = pricingData.sale_price[size];
                        console.log(`Last resort: using sale_price for ${size}: ${pricingData.sale_price[size]}`);
                    }
                }
            }
            
            // Now update the cells using our combined data
            cells.forEach((cell, index) => {
                const size = displayedSizes[index];
                if (size && combinedPriceData[size]) {
                    console.log(`Updating case price cell ${index} for size ${size} with value: ${combinedPriceData[size]}`);
                    cell.textContent = combinedPriceData[size].toFixed(2);
                } else {
                    console.warn(`Missing price data for size ${size} in both case_price and original_price`);
                    // Try direct access as last resort
                    if (size && pricingData.case_price && pricingData.case_price[size]) {
                        cell.textContent = pricingData.case_price[size].toFixed(2);
                        console.log(`Last resort: using direct case_price for ${size}: ${pricingData.case_price[size]}`);
                    } else if (size && pricingData.original_price && pricingData.original_price[size]) {
                        cell.textContent = pricingData.original_price[size].toFixed(2);
                        console.log(`Last resort: using direct original_price for ${size}: ${pricingData.original_price[size]}`);
                    } else {
                        console.error(`No price data available for size ${size}`);
                    }
                }
            });
        } else {
            console.error("Cannot find the case price row to update");
        }
        
        // Determine if we need to show the sale price row
        // Only show it if there's a sale AND the sale price is better than the program price for at least one size
        if (salePriceRow) {
            let showSalePriceRow = false;
            
            if (hasSale && pricingData.sale_price && pricingData.program_price) {
                // Check if the sale price is better than the program price for any size
                for (const size of displayedSizes) {
                    if (size &&
                        pricingData.sale_price[size] &&
                        pricingData.program_price[size] &&
                        pricingData.sale_price[size] < pricingData.program_price[size]) {
                        showSalePriceRow = true;
                        break;
                    }
                }
            }
            
            if (showSalePriceRow) {
                salePriceRow.style.display = '';
                // Update sale price values
                const cells = salePriceRow.querySelectorAll('td:not(:first-child)');
                cells.forEach((cell, index) => {
                    const size = displayedSizes[index];
                    if (size && pricingData.sale_price[size]) {
                        cell.textContent = pricingData.sale_price[size].toFixed(2);
                    }
                });
            } else {
                // Hide sale price row if there's no sale or if program price is better
                salePriceRow.style.display = 'none';
            }
        }
        
        // Always show program price row
        if (programPriceRow) {
            programPriceRow.style.display = '';
            
            // Update program price values
            if (pricingData.program_price) {
                const cells = programPriceRow.querySelectorAll('td:not(:first-child)');
                cells.forEach((cell, index) => {
                    const size = displayedSizes[index];
                    if (size && pricingData.program_price[size]) {
                        cell.textContent = pricingData.program_price[size].toFixed(2);
                    }
                });
            }
        }
        
        console.log('Pricing display updated successfully');
    }

    // Wait until DOM is fully loaded before attaching event handlers
    document.addEventListener('DOMContentLoaded', function() {
        // Find and set up the color swatches with proper error handling
        try {
            // Set up the color swatches
            document.querySelectorAll('.color-swatch').forEach(function(swatch) {
                swatch.addEventListener('click', function() {
                    try {
                        // Extract data attributes safely with explicit debug info
                        const catalogColor = this.getAttribute('data-catalog-color') || '';
                        const displayColor = this.getAttribute('data-display-color') || catalogColor;
                        const imageUrl = this.getAttribute('data-image') || '';
                        
                        console.log(`Swatch clicked: ${catalogColor}, display: ${displayColor}, image: ${imageUrl}`);
                        
                        // Stop here if we don't have a valid catalog color
                        if (!catalogColor) {
                            console.error('No catalog color found on swatch element');
                            return;
                        }
                        
                        // Stop here if we don't have a valid image URL
                        if (!imageUrl) {
                            console.warn('No image URL found on swatch element');
                            // Continue anyway as we can update other elements
                        }
                        
                        // Safely update selected color text
                        const selectedColorElement = document.getElementById('selected-color');
                        if (selectedColorElement) {
                            selectedColorElement.textContent = displayColor;
                            console.log(`Updated selected color text to: ${displayColor}`);
                        } else {
                            console.error('Selected color element not found');
                        }
                        
                        // Update active swatch styling
                        document.querySelectorAll('.color-swatch').forEach(s => {
                            s.classList.remove('active');
                            s.classList.remove('border-primary');
                        });
                        this.classList.add('active');
                        this.classList.add('border-primary');
                        console.log(`Updated active swatch to: ${catalogColor}`);
                        
                        // Safely update product image - this is critical!
                        const productImage = document.getElementById('product-image');
                        if (productImage && imageUrl) {
                            console.log(`Updating image from ${productImage.src} to ${imageUrl}`);
                            
                            // Force a reflow with a small timeout to ensure the image updates
                            setTimeout(() => {
                                productImage.src = imageUrl;
                                
                                // Also update the alt text for accessibility
                                if (productImage.alt) {
                                    const altParts = productImage.alt.split(' ');
                                    if (altParts.length > 1) {
                                        productImage.alt = `${displayColor} ${altParts.slice(1).join(' ')}`;
                                    } else {
                                        productImage.alt = displayColor;
                                    }
                                } else {
                                    productImage.alt = displayColor;
                                }
                                
                                console.log(`Image updated to: ${imageUrl}`);
                            }, 10);
                        } else {
                            console.error(`Product image element ${productImage ? 'found' : 'not found'}, imageUrl ${imageUrl ? 'valid' : 'invalid'}`);
                        }
                        
                        // Hide all inventory tables
                        const allTables = document.querySelectorAll('.inventory-tables');
                        console.log(`Found ${allTables.length} inventory tables to hide`);
                        allTables.forEach(table => {
                            table.style.display = 'none';
                        });
                        
                        // Get the corresponding inventory table for this color
                        // Try multiple approaches to find the right table
                        
                        // First: Try direct ID match using fully sanitized catalog color
                        // Replace all potentially problematic characters
                        const safeColorId = catalogColor.replace(/[\/\s.&]+/g, '-');
                        let tableId = `inventory-${safeColorId}`;
                        console.log(`Looking for table with ID: ${tableId}`);
                        let table = document.getElementById(tableId);
                        
                        // Second: Try with more aggressive sanitization
                        if (!table) {
                            // Try even more aggressive sanitization - removing special chars completely
                            const extraSafeColorId = catalogColor.replace(/[^a-zA-Z0-9]/g, '');
                            tableId = `inventory-${extraSafeColorId}`;
                            console.log(`Not found, trying more aggressive ID: ${tableId}`);
                            table = document.getElementById(tableId);
                        }
                        
                        // Third: Try to match using the exact ID from the template
                        if (!table) {
                            console.warn(`Table not found by sanitized IDs, trying exact catalog color...`);
                            table = document.getElementById(`inventory-${catalogColor}`);
                        }
                        
                        // Fourth: Try using a partial match on the ID attribute
                        if (!table) {
                            console.warn(`Still no match, trying partial ID match`);
                            const tables = document.querySelectorAll('.inventory-tables');
                            for (const t of tables) {
                                if (t.id.includes(catalogColor) || catalogColor.includes(t.id.replace('inventory-', ''))) {
                                    table = t;
                                    console.log(`Found table with partial ID match: ${t.id}`);
                                    break;
                                }
                            }
                        }
                        
                        // Fifth: Try matching by data-display-color attribute
                        if (!table) {
                            console.warn(`Table not found by ID matching, trying data-display-color attribute...`);
                            table = document.querySelector(`.inventory-tables[data-display-color="${displayColor}"]`);
                            
                            // Try partial match on data-display-color as well
                            if (!table) {
                                const tables = document.querySelectorAll('.inventory-tables');
                                for (const t of tables) {
                                    const dataColor = t.getAttribute('data-display-color');
                                    if (dataColor && (dataColor.includes(displayColor) || displayColor.includes(dataColor))) {
                                        table = t;
                                        console.log(`Found table with partial data-display-color match: ${dataColor}`);
                                        break;
                                    }
                                }
                            }
                        }
                        
                        // If we found a table, show it and update its data
                        if (table) {
                            // Update the inventory table header and content to match the selected color
                            const inventoryHeader = table.querySelector('h4');
                            if (inventoryHeader) {
                                inventoryHeader.textContent = `Inventory for ${displayColor}`;
                            }
                            
                            const inventoryTotal = table.querySelector('.inventory-total');
                            if (inventoryTotal) {
                                inventoryTotal.textContent = `Total inventory for ${displayColor}`;
                            }
                            
                            const pricingHeader = table.querySelector('.card-header h3');
                            if (pricingHeader) {
                                pricingHeader.textContent = `Pricing for ${displayColor}`;
                            }
                            
                            // Show the table
                            table.style.display = '';
                            console.log(`Showing inventory table for ${displayColor}`);
                            
                            // Fetch updated pricing data
                            const path = window.location.pathname;
                            const style = path.includes('/') ? path.split('/').pop() : path;
                            
                            if (style) {
                                // Show main loading spinner for color change
                                const spinner = document.getElementById('loading-spinner');
                                if (spinner) {
                                    spinner.querySelector('.spinner-message').textContent = 'Loading color data...';
                                    spinner.style.display = 'flex';
                                    
                                    // Safety timeout - force hide spinner after 8 seconds
                                    setTimeout(() => {
                                        spinner.style.display = 'none';
                                    }, 8000);
                                }
                                
                                console.log(`Fetching pricing data for style: ${style}, color: ${catalogColor}`);
                                fetchColorPricing(style, catalogColor)
                                    .then(data => {
                                        // Hide main loading spinner
                                        if (spinner) {
                                            spinner.style.display = 'none';
                                        }
                                        if (data && !data.error) {
                                            console.log(`Successfully retrieved pricing data for ${displayColor}`, data);
                                            updatePricingDisplay(data, table.id);
                                            
                                            // Hide the error message if visible
                                            const errorElement = table.querySelector('.price-error');
                                            if (errorElement) {
                                                errorElement.style.display = 'none';
                                            }
                                        } else {
                                            // Show error message but still try to use the data we got
                                            console.warn(`Received error or incomplete pricing data`, data);
                                            if (data) updatePricingDisplay(data, table.id);
                                            
                                            const errorElement = table.querySelector('.price-error');
                                            if (errorElement) {
                                                errorElement.style.display = 'block';
                                            }
                                        }
                                    })
                                    .catch(error => {
                                        console.error(`Error updating pricing: ${error.message}`);
                                        
                                        // Hide loading spinner if there's an error
                                        const spinner = document.getElementById('loading-spinner');
                                        if (spinner) {
                                            spinner.style.display = 'none';
                                        }
                                        
                                        // Show error message
                                        const errorElement = table.querySelector('.price-error');
                                        if (errorElement) {
                                            errorElement.style.display = 'block';
                                            errorElement.querySelector('p').textContent = 'Unable to fetch current pricing. Showing cached data.';
                                        }
                                    });
                            }
                        } else {
                            // Last resort - just show the first inventory table if we really can't find a match
                            console.error(`No matching table found for color: ${displayColor}`);
                            const firstTable = document.querySelector('.inventory-tables');
                            if (firstTable) {
                                // Update headers to match the selected color
                                const inventoryHeader = firstTable.querySelector('h4');
                                if (inventoryHeader) {
                                    inventoryHeader.textContent = `Inventory for ${displayColor}`;
                                }
                                
                                const inventoryTotal = firstTable.querySelector('.inventory-total');
                                if (inventoryTotal) {
                                    inventoryTotal.textContent = `Total inventory for ${displayColor}`;
                                }
                                
                                const pricingHeader = firstTable.querySelector('.card-header h3');
                                if (pricingHeader) {
                                    pricingHeader.textContent = `Pricing for ${displayColor}`;
                                }
                                
                                firstTable.style.display = '';
                                console.log(`Showing first available inventory table as last resort`);
                                
                                // At least try to fetch the pricing
                                const path = window.location.pathname;
                                const style = path.includes('/') ? path.split('/').pop() : path;
                                if (style) {
                                    fetchColorPricing(style, catalogColor)
                                        .then(data => {
                                            if (data) updatePricingDisplay(data, firstTable.id);
                                        })
                                        .catch(error => {
                                            console.error(`Error updating pricing: ${error.message}`);
                                            const errorElement = firstTable.querySelector('.price-error');
                                            if (errorElement) {
                                                errorElement.style.display = 'block';
                                            }
                                        });
                                }
                            }
                        }
                    } catch (err) {
                        console.error('Error in swatch click handler:', err);
                    }
                });
            });
            
            // Select the first color by default
            const firstSwatch = document.querySelector('.color-swatch');
            if (firstSwatch) {
                // Use setTimeout to ensure DOM is fully loaded
                setTimeout(() => {
                    firstSwatch.click();
                }, 100);
            }
            
            // GLOBAL SAFETY - Force hide any stuck spinners after page load
            setTimeout(function() {
                console.log("Safety timeout - hiding any stuck spinners");
                // Force hide all spinners and loading indicators
                const allSpinners = document.querySelectorAll('.spinner-border, .spinner-grow, #loading-spinner, [id^="loading-"]');
                allSpinners.forEach(function(spinner) {
                    spinner.style.display = 'none';
                });
                
                // Also add a style tag for extra safety
                const style = document.createElement('style');
                style.textContent = '.spinner-border, .spinner-grow, #loading-spinner, [id^="loading-"] { display: none !important; }';
                document.head.appendChild(style);
            }, 10000); // 10 second timeout as a last resort
        } catch (err) {
            console.error('Error setting up color swatches:', err);
        }
    });
</script>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
